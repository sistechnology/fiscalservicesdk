# fiscalservicesdk

This repository provides a guidance on integrating an Android app with myPOS CarbonFiscal device. Once integrated, the app will be able to communicate with the fiscal core device components in order to manage all fiscal operations required by the bulgarian fiscal law - registering sales in the fiscal memory of the device, fiscal tickets and inovices printing, fiscal reports printing etc.).
The built-in functionalities of fiscalservicesdk allows you to send requsts to CarbonFiscal device in order to perform fiscal operations, using a specialy developed myPOS CarbonFiscal POS Communication Protocol. It is a high level protocol, based on the JSON-RPC 2.0 standard.
Since The CarbonFiscal device provides fiscal and EFT functions as well, the Communication Protocol provides also card payments processing (including but not limited to VISA and Mastercard).
Please follow the attached description of the protocol to understand the fiscal and payment operations essence.


### Table of Contents
* [Installation](#installation)
* [Usage](#Usage)
	* [Fiscal Controller Utilization](#fiscal-controller-utilization)
	* [Perform a Fiscal Command Requests](#perform-fiscal-command-request)
	* [Fiscal Command Request Example](#fiscal-command-request-example)


## [Installation]

1. build the project fiscalservicesdk or use the fiscalservicesdk.aar package from the repository
2. include fiscalservicesdk.aar in your project.

## [Usage]


### Fiscal Controller Utilization

Ones per app lifecicle the bind method must be invoked to utilize the fiscal controller connection.

```java
FiscalService.getInstance().bind(.....);
```

### Perform Fiscal Command Request

Use exchangeCommand method to perform a Fiscal Command Request.
Fiscal commands must be generated by the app and must comply with JSON-RPC 2.0 standard (Request Object and Response Object - see the examples bellow). 
The Fiscal device provides a Fisacl Command Request validation. The incorrect requests are rejected.
Please follow the CarbonFiscal Communication Protocol description to get more information abaut Request Object and Response Object structure reqirements.


```java

String response =  FiscalService.getInstance().exchangeCommand(jsonCommand, timeout);

//jsonCommand is a json formatted String, containing a valid Fiscal Command request, according to the CarbonFiscal Communication Protocol description.
//timeout is defined in miliseconds.
//response is a json formatted String, containing a the Fiscal Command execution response, according to the CarbonFiscal Communication Protocol description.
```

### Fiscal Command Request Example

The following Fiscal Command Request Object shows how to request sale registration and fiscal ticket printing on myPOS CarbonFiscal device:


```json
{
	"id": 8,
	"jsonrpc": "2.0",
	"method": "PrintReceipt",
	"params": {
		"beginFiscalReceiptInput": {
			"cashDesk": 1,
			"operatorName": "Оператор 1",
			"operatorNumber": 1
		},
		"invoiceData": null,
		"items": [
			{
				"department": 0,
				"name": "Кока Кола 2л.",
				"price": 2.4,
				"quantity": 3,
				"type": "ITEM",
				"vat": "B"
			},
			{
				"department": 1,
				"discountType": "DiscountByPercentage",
				"discountValue": 10,
				"name": "Фанта 1.5л.",
				"price": 2.15,
				"quantity": 2,
				"type": "ITEM",
				"vat": "B"
			},
			{
				"department": 2,
				"discountType": "DiscountBySum",
				"discountValue": 2,
				"name": "Спрайт 1л.",
				"price": 1.75,
				"quantity": 5,
				"type": "ITEM",
				"vat": "D"
			},
			{
				"text": "Промоция",
				"type": "TEXT"
			},
			{
				"text": "\"Вземи 5 и спести 2лв.\"",
				"type": "TEXT"
			}
		],
		"payments": [
			{
				"amount": 10,
				"line1": "Чек де Жене",
				"type": "PAYMENT_CHEQUE"
			},
			{
				"amount": 7.82,
				"type": "PAYMENT_CASH"
			}
		],
		"stornoData": null,
		"textAfterPayment": [
			{
				"text": "Вземете 20% отстъпка",
				"type": "TEXT"
			},
			{
				"text": "при следваща покупка",
				"type": "TEXT"
			},
			{
				"text": "като сканирате този",
				"type": "TEXT"
			},
			{
				"text": "баркод:",
				"type": "TEXT"
			},
			{
				"text": "DISCOUNT2",
				"type": "EAN128"
			}
		]
	}
}

```


The following Fiscal Command Response Object shows the answer of the upper request:

```json
{
	"result": {
		"invoiceNumber": 0,
		"payments": [
			{
				"amount": 10.0,
				"count": 1,
				"key": "PAYMENT_CHEQUE"
			},
			{
				"amount": 7.82,
				"count": 1,
				"key": "PAYMENT_CASH"
			}
		],
		"qrCode": "51300015*0000048*2022-03-04*17:48:10*17.82",
		"salesByDepartment": [
			{
				"amount": 6.75,
				"count": 1,
				"key": 2
			},
			{
				"amount": 3.87,
				"count": 1,
				"key": 1
			},
			{
				"amount": 7.2,
				"count": 1,
				"key": 0
			}
		],
		"salesByVat": [
			{
				"amount": 17.82,
				"count": 3,
				"key": "B"
			}
		],
		"salesTotal": 17.82,
		"salesVat": [
			{
				"amount": 2.97,
				"count": 3,
				"key": "B"
			}
		],
		"printResult": "SUCCESS",
		"receiptDate": "2022-03-04T17:48:10",
		"receiptNumber": 48,
		"zNumber": 13
	},
	"id": 8,
	"jsonrpc": "2.0"
}




```